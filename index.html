<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snap2Cal - One Snap. Zero Mental Load.</title>
    <link rel="icon" type="image/svg+xml" href="Snap2CalLogos/Favicons/Snap2Cal_favicon01_charcoal.svg">
    <link rel="alternate icon" type="image/png" href="Snap2CalLogos/Favicons/Snap2Cal_favicon01_charcoal.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-title" content="Snap2Cal">
    <meta name="application-name" content="Snap2Cal">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom, #FFFFFF 0%, #a1bed1 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .logo {
            width: 200px;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
        }

        .subtitle .headline {
            color: #333;
            font-size: 1.4em;
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }

        .subtitle .tagline {
            color: #7c8b9a;
            font-size: 1.1em;
            font-weight: 400;
            letter-spacing: 0.5px;
        }
        
        .upload-section {
            border: 2px dashed #d0dfe6;
            border-radius: 12px;
            padding: 48px 32px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: rgba(238, 242, 255, 0.5);
        }

        .upload-section:hover:not(.has-file) {
            border-color: #b8ced9;
            background-color: #eef3f6;
        }

        .upload-section.dragover {
            background-color: #eef3f6;
            border-color: #a1bed1;
            transform: scale(0.98);
        }

        .upload-section.has-file {
            background-color: #ede1d4;
            border-color: #d4a088;
            padding: 16px 20px;
        }

        .upload-section.has-file .upload-content {
            flex-direction: row;
            justify-content: flex-start;
            gap: 16px;
        }

        .upload-section.has-file .upload-content > div {
            text-align: left;
        }

        input[type="file"] {
            display: none;
        }

        .upload-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            color: #3b402B;
        }

        .upload-section.has-file .upload-icon {
            color: #3B402B;
        }

        .upload-label {
            display: block;
            font-size: 1.1em;
            color: #3b402B;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .upload-section.has-file .upload-label {
            color: #3B402B;
        }

        .upload-sublabel {
            display: block;
            font-size: 0.9em;
            color: #3b402B;
            font-weight: 400;
        }

        .upload-section.has-file .upload-sublabel {
            color: rgba(59, 64, 43, 0.7);
        }

        .upload-thumbnail {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #d4a088;
        }

        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .logo {
                width: 150px;
            }

            h1 {
                font-size: 2em;
            }

            .subtitle .headline {
                font-size: 1.25em;
            }

            .subtitle .tagline {
                font-size: 1em;
            }

            .upload-section {
                padding: 32px 20px;
            }

            .upload-icon {
                width: 36px;
                height: 36px;
            }

            .upload-label {
                font-size: 1em;
            }

            .upload-sublabel {
                font-size: 0.85em;
            }

            .signed-in-info {
                padding: 8px;
                gap: 8px;
            }

            .user-profile {
                gap: 8px;
                flex: 1;
                min-width: 0;
            }

            .user-profile-pic {
                width: 32px;
                height: 32px;
            }

            .user-name {
                font-size: 0.85em;
            }

            .user-email {
                font-size: 0.75em;
            }

            .sign-out-btn {
                font-size: 0.8em;
                white-space: nowrap;
            }

            button {
                padding: 12px 20px;
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .logo {
                width: 100px;
                margin-bottom: 12px;
            }

            h1 {
                font-size: 1.75em;
            }

            .subtitle {
                margin-bottom: 20px;
            }

            .subtitle .headline {
                font-size: 1.1em;
            }

            .subtitle .tagline {
                font-size: 0.9em;
            }

            .upload-section {
                padding: 24px 16px;
            }

            .upload-icon {
                width: 32px;
                height: 32px;
            }

            .upload-label {
                font-size: 0.95em;
            }

            .upload-sublabel {
                font-size: 0.8em;
            }

            .signed-in-info {
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }

            .user-profile {
                width: 100%;
                justify-content: center;
            }

            .user-profile-pic {
                width: 28px;
                height: 28px;
            }

            .user-name {
                font-size: 0.8em;
            }

            .user-email {
                font-size: 0.7em;
                word-break: break-all;
            }

            .sign-out-btn {
                font-size: 0.85em;
            }
        }

        button {
            background: linear-gradient(135deg, #a1bed1 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .button-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .button-icon {
            width: 18px;
            height: 18px;
        }
        
        .events-preview {
            margin-top: 20px;
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            max-height: none;
            overflow-y: visible;
        }

        .ai-narrative {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border-left: 4px solid #a1bed1;
        }

        .ai-icon {
            font-size: 1.4em;
            flex-shrink: 0;
        }

        .ai-message {
            color: #3b402b;
            font-size: 1em;
            line-height: 1.5;
            font-weight: 500;
        }

        @media (max-width: 480px) {
            .ai-narrative {
                padding: 12px 14px;
                gap: 10px;
            }

            .ai-icon {
                font-size: 1.2em;
            }

            .ai-message {
                font-size: 0.9em;
            }
        }

        .events-preview h3 {
            margin-bottom: 16px;
            font-size: 1.2em;
            color: #333;
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .event-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #a1bed1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .event-item:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .event-item.added {
            border-left-color: #10b981;
            background-color: rgba(209, 250, 229, 0.3);
        }

        .event-content {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
        }

        .event-info {
            flex: 1;
            min-width: 0;
        }

        .event-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            font-size: 1.05em;
        }

        .event-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .event-detail-row {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.9em;
        }

        .event-detail-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            color: #a1bed1;
        }

        .event-button {
            background: #a1bed1;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            width: auto;
            margin-top: 0;
        }

        .event-button:hover:not(:disabled) {
            background: #5568d3;
        }

        .event-button:disabled {
            cursor: not-allowed;
        }

        .event-button.added {
            background: #d1fae5;
            color: #047857;
        }

        .event-button.added:hover {
            background: #d1fae5;
        }

        .event-edit-button {
            background: #e0e7ff;
            color: #4f46e5;
            text-decoration: none;
            margin-top: 8px;
        }

        .event-edit-button:hover {
            background: #c7d2fe;
        }

        .event-button-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .event-buttons-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            flex-shrink: 0;
        }

        /* Keep "Added" text always visible */
        .event-button.added .event-button-text {
            display: inline;
        }

        @media (max-width: 640px) {
            .event-button-text {
                display: none;
            }

            /* But always show "Added" text */
            .event-button.added .event-button-text {
                display: inline;
            }

            .event-content {
                gap: 12px;
            }

            .event-item {
                padding: 16px;
            }
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.9em;
        }
        
        .footer-company {
            font-weight: 600;
            color: #3b402b;
        }

        .report-problem-link {
            display: block;
            text-align: center;
            margin-top: 16px;
            color: #666;
            font-size: 0.85em;
            cursor: pointer;
            text-decoration: underline;
        }

        .report-problem-link:hover {
            color: #333;
        }

        .report-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .report-modal-overlay.active {
            display: flex;
        }

        .report-modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .report-modal h3 {
            margin-bottom: 8px;
            color: #3b402b;
        }

        .report-modal p {
            margin-bottom: 16px;
            color: #666;
            font-size: 0.9em;
        }

        .report-modal textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d0dfe6;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 16px;
        }

        .report-modal textarea:focus {
            outline: none;
            border-color: #a1bed1;
        }

        .report-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .report-modal-buttons button {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-cancel-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
        }

        .report-cancel-btn:hover {
            background: #e5e7eb;
        }

        .report-submit-btn {
            background: #a1bed1;
            border: none;
            color: white;
        }

        .report-submit-btn:hover {
            background: #8fafc4;
        }

        .report-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #googleSignIn {
            margin-bottom: 20px;
        }

        #googleSignIn button {
            background: #d4a088;
            box-shadow: 0 4px 12px rgba(212, 160, 136, 0.4);
        }

        #googleSignIn button:hover:not(:disabled) {
            background: #c48e78;
            box-shadow: 0 6px 16px rgba(212, 160, 136, 0.5);
        }

        .signed-in-info {
            background-color: #ede1d4;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: #3B402B;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #3B402B;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95em;
        }

        .user-email {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .sign-out-btn {
            background: none;
            border: none;
            color: #3B402B;
            font-size: 0.85em;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            margin: 0;
            font-weight: 500;
            transition: opacity 0.2s ease;
        }

        .sign-out-btn:hover {
            opacity: 0.7;
        }

        .sign-out-link {
            background: none !important;
            border: none;
            color: #a1bed1;
            font-size: 0.75em;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            margin: 0;
            font-weight: 400;
            transition: opacity 0.2s ease;
            box-shadow: none !important;
            display: inline;
            width: auto;
            border-radius: 0;
        }

        .sign-out-link:hover {
            opacity: 0.7;
            transform: none !important;
        }

        .how-it-works {
            background-color: #f8f9ff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .how-it-works h2 {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 16px;
            text-align: center;
        }

        .how-it-works-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .how-it-works-list li {
            font-size: 1.05em;
            color: #555;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .how-it-works-list li:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .how-it-works {
                padding: 20px;
            }

            .how-it-works h2 {
                font-size: 1.3em;
            }

            .how-it-works-list li {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .how-it-works {
                padding: 12px 16px;
                margin-bottom: 20px;
            }

            .how-it-works h2 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }

            .how-it-works-list li {
                font-size: 0.9em;
                margin-bottom: 6px;
                line-height: 1.4;
            }
        }

        .why-sign-in {
            background-color: #ede1d4;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #d4a088;
        }

        .why-sign-in h3 {
            font-size: 1.2em;
            color: #3B402B;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .why-sign-in p {
            font-size: 0.95em;
            color: #3B402B;
            line-height: 1.6;
            margin: 0;
        }

        @media (max-width: 768px) {
            .why-sign-in {
                padding: 16px;
            }

            .why-sign-in h3 {
                font-size: 1.1em;
            }

            .why-sign-in p {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .why-sign-in {
                padding: 10px 12px;
                margin-bottom: 15px;
            }

            .why-sign-in h3 {
                font-size: 0.65em;
                margin-bottom: 4px;
            }

        .why-sign-in p {
            font-size: 0.65em;
            line-height: 1.4;
        }
    }

    /* Email Capture Form Styles */
    .snap2cal-email-form input[type="email"]:focus {
        outline: none;
        border-color: #a1bed1;
        box-shadow: 0 0 0 3px rgba(161, 190, 209, 0.1);
    }

    .email-form-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .email-form-message {
        font-size: 0.875rem;
    }

    .email-form-message.success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .email-form-message.error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    </style>
</head>
<body>
    <div class="container">
        <img src="Snap2CalLogos/Snap2Cal_Logo_500px.png" alt="Snap2Cal Logo" class="logo">
        <p class="subtitle">
            <span class="headline">One Snap. Zero Mental Load.</span>
            <span class="tagline">Transform Images into Calendar Events</span>
        </p>

        <div id="howItWorks" class="how-it-works">
            <h2>How it works</h2>
            <ul class="how-it-works-list">
                <li>ðŸ”— Connect to your Google account</li>
                <li>ðŸ“¸ Upload an image of an event flyer, schedule, or invitation</li>
                <li>âœ¨ AI extracts the event details automatically</li>
                <li>ðŸ“… Add events to your Google Calendar with one click</li>
            </ul>
        </div>

        <div id="googleSignIn"></div>

        <div id="whySignIn" class="why-sign-in">
            <h3>Why sign in with Google?</h3>
            <p>Snap2Cal connects to your Google Calendar so it can create events for you. We only add events you approve â€” we never read or modify your existing calendar.</p>
        </div>
        <div id="signedInInfo" class="signed-in-info" style="display: none;"></div>
        <div id="signOutLink" style="display: none; text-align: right; margin-top: -15px; margin-bottom: 10px;">
            <button class="sign-out-link" onclick="signOut()">Sign Out</button>
        </div>

        <div class="upload-section" id="uploadSection" style="display: none;">
            <input type="file" id="fileInput" accept=".pdf,image/*">
            <div class="upload-content">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 15V3M12 3L8 7M12 3L16 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 17L2 19C2 20.1046 2.89543 21 4 21L20 21C21.1046 21 22 20.1046 22 19V17" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div>
                    <span class="upload-label">Click to upload an image</span>
                    <span class="upload-sublabel">or drag and drop</span>
                </div>
            </div>
        </div>
        
        <button id="processBtn" style="display: none;">
            <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>Process Image</span>
        </button>
        <button id="addToCalendarBtn" style="display: none;">Add Events to Calendar</button>

        <div id="eventsPreview" class="events-preview" style="display: none;"></div>

        <div id="reportProblemLink" class="report-problem-link" style="display: none;" onclick="openReportModal()">
            It didn't work? Report a problem
        </div>

        <!-- Hidden form for Netlify to detect at build time -->
        <form name="problem-report" netlify netlify-honeypot="bot-field" hidden>
            <input type="text" name="bot-field">
            <textarea name="description"></textarea>
            <input type="file" name="uploaded-file">
        </form>

        <!-- Report Problem Modal -->
        <div id="reportModalOverlay" class="report-modal-overlay" onclick="closeReportModal(event)">
            <div class="report-modal" onclick="event.stopPropagation()">
                <h3>Report a Problem</h3>
                <p>Let us know what went wrong and we'll look into it.</p>
                <form id="reportForm" name="problem-report" method="POST" data-netlify="true" enctype="multipart/form-data">
                    <input type="hidden" name="form-name" value="problem-report">
                    <input type="hidden" name="bot-field">
                    <textarea name="description" placeholder="What happened? What did you expect?" required></textarea>
                    <input type="file" name="uploaded-file" id="reportFileInput" style="display: none;">
                    <p id="reportFileInfo" style="font-size: 0.85em; color: #666; margin: -8px 0 16px;"></p>
                    <div class="report-modal-buttons">
                        <button type="button" class="report-cancel-btn" onclick="closeReportModal()">Cancel</button>
                        <button type="submit" class="report-submit-btn">Send Report</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Email Capture Section -->
        <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%); border-radius: 12px; padding: 24px; margin: 30px 0; text-align: center;">
            <h3 style="color: #3b402b; margin-bottom: 12px; font-size: 1.2em; font-weight: 600;">Stay Updated on Snap2Cal</h3>
            <p style="color: #555; margin-bottom: 20px; font-size: 0.95em;">Get notified about product updates, new features, and tips for getting the most out of Snap2Cal.</p>
            <form class="snap2cal-email-form" data-source="homepage" style="max-width: 400px; margin: 0 auto;">
                <input 
                    type="email" 
                    placeholder="Enter your email address" 
                    required
                    style="width: 100%; padding: 12px; border: 1px solid #d0dfe6; border-radius: 8px; font-size: 1em; margin-bottom: 12px; font-family: inherit;"
                    aria-label="Email address for Snap2Cal updates"
                >
                <button type="submit" class="email-form-button" data-original-text="Subscribe" style="width: 100%; padding: 12px; background: #a1bed1; color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                    Subscribe
                </button>
                <div class="email-form-message" style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 0.9em;"></div>
            </form>
        </div>

        <div class="footer">
            <strong class="footer-company">Snap2Cal</strong><br>
            Â© 2025 AmandaMade Digital Studio<br>
            <a href="/privacy" style="color: #a1bed1; font-size: 0.9em; margin-top: 10px; display: inline-block;">Privacy Policy</a> | <a href="/faq" style="color: #a1bed1; font-size: 0.9em;">FAQs</a>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let extractedEvents = [];
        let accessToken = null;
        let refreshToken = null;
        let tokenExpiresAt = null;
        let refreshTimer = null;
        let userInfo = null;

        // ============ SESSION MANAGEMENT ============

        // Throttle token validation
        let lastTokenCheck = 0;
        const TOKEN_CHECK_INTERVAL = 5 * 60 * 1000; // 5 minutes

        // Check token when tab becomes visible
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && accessToken) {
                const now = Date.now();
                if (now - lastTokenCheck > TOKEN_CHECK_INTERVAL) {
                    lastTokenCheck = now;
                    const isValid = await validateToken();
                    if (!isValid) {
                        // Try to refresh the token first
                        const refreshed = await refreshAccessToken();
                        if (!refreshed) {
                            handleExpiredSession();
                        }
                    }
                }
            }
        });

        async function validateToken() {
            try {
                const response = await fetch(
                    'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + accessToken
                );
                return response.ok;
            } catch {
                return false;
            }
        }

        // Pre-action validation (belt and suspenders)
        async function ensureValidToken() {
            if (!accessToken) return false;

            const isValid = await validateToken();
            if (!isValid) {
                // Try to refresh the token first
                const refreshed = await refreshAccessToken();
                if (!refreshed) {
                    handleExpiredSession();
                    return false;
                }
            }
            lastTokenCheck = Date.now();
            return true;
        }

        function handleExpiredSession() {
            // Clear all credentials but preserve extracted events
            accessToken = null;
            refreshToken = null;
            tokenExpiresAt = null;
            userInfo = null;

            // Cancel scheduled refresh
            if (refreshTimer) {
                clearTimeout(refreshTimer);
                refreshTimer = null;
            }

            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_refresh_token');
            localStorage.removeItem('google_token_expires_at');
            localStorage.removeItem('google_user_info');

            // Hide file preview and process button
            selectedFile = null;
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processBtn').style.display = 'none';

            // Count unadded events
            const unaddedCount = document.querySelectorAll('.event-item:not(.added)').length;

            // Show reconnect prompt in the signed-in area
            showReconnectPrompt(unaddedCount);
        }

        function showReconnectPrompt(unaddedCount) {
            const signedInInfo = document.getElementById('signedInInfo');
            const signOutLink = document.getElementById('signOutLink');
            const googleSignIn = document.getElementById('googleSignIn');

            // Hide the regular sign-in button and sign-out link
            googleSignIn.style.display = 'none';
            signOutLink.style.display = 'none';

            // Build the message
            const message = unaddedCount > 0
                ? `Your session expired, but your ${unaddedCount} event${unaddedCount > 1 ? 's are' : ' is'} still here.`
                : 'Your session expired.';

            signedInInfo.innerHTML = `
                <div style="width: 100%; text-align: center;">
                    <div style="margin-bottom: 12px; color: #3B402B;">
                        <svg style="width: 24px; height: 24px; margin-bottom: 8px; opacity: 0.7;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <div style="font-weight: 600; margin-bottom: 4px;">${message}</div>
                        <div style="font-size: 0.85em; opacity: 0.8;">Sign in again to continue.</div>
                    </div>
                    <button onclick="reconnect()" style="
                        background: #d4a088;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 0.95em;
                        font-weight: 600;
                        cursor: pointer;
                        width: auto;
                        display: block;
                        margin: 0 auto;
                        box-shadow: 0 2px 8px rgba(212, 160, 136, 0.4);
                    ">
                        Reconnect with Google
                    </button>
                </div>
            `;
            signedInInfo.style.display = 'flex';
            signedInInfo.style.background = '#fef3ed';
            signedInInfo.style.borderLeft = '4px solid #d4a088';
        }

        function reconnect() {
            // Trigger the Google OAuth flow using authorization code
            const codeClient = google.accounts.oauth2.initCodeClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                ux_mode: 'popup',
                callback: async (response) => {
                    if (response.error) {
                        console.error('Auth error:', response.error);
                        return;
                    }

                    try {
                        const tokens = await exchangeCodeForTokens(response.code);
                        await handleAuthSuccess(tokens);

                        // Reset the signed-in info styling
                        const signedInInfo = document.getElementById('signedInInfo');
                        signedInInfo.style.background = '#ede1d4';
                        signedInInfo.style.borderLeft = 'none';

                        updateUploadSection();
                        showWelcomeBack();
                    } catch (error) {
                        console.error('Token exchange failed:', error);
                    }
                },
            });
            codeClient.requestCode();
        }

        function showWelcomeBack() {
            // Brief toast-style notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #047857;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.95em;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            toast.innerHTML = `
                <svg style="width: 18px; height: 18px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Welcome back!
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s ease';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // Google Sign-In Configuration
        const CLIENT_ID = '406862514908-nio59o975hs7k038g3jo40tf51pelk7g.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';

        // Exchange authorization code for tokens (including refresh token)
        async function exchangeCodeForTokens(code) {
            const response = await fetch('/.netlify/functions/exchange-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.details || 'Failed to exchange code');
            }

            return response.json();
        }

        // Refresh access token using refresh token
        async function refreshAccessToken() {
            if (!refreshToken) return false;

            try {
                const response = await fetch('/.netlify/functions/refresh-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                if (!response.ok) {
                    console.log('Refresh token expired or invalid');
                    return false;
                }

                const data = await response.json();
                accessToken = data.access_token;
                tokenExpiresAt = Date.now() + (data.expires_in * 1000);

                localStorage.setItem('google_access_token', accessToken);
                localStorage.setItem('google_token_expires_at', tokenExpiresAt);

                scheduleTokenRefresh(data.expires_in);
                lastTokenCheck = Date.now();

                console.log('Token refreshed successfully');
                return true;
            } catch (error) {
                console.error('Error refreshing token:', error);
                return false;
            }
        }

        // Schedule automatic token refresh before expiry
        function scheduleTokenRefresh(expiresIn) {
            if (refreshTimer) clearTimeout(refreshTimer);

            // Refresh 5 minutes before expiry
            const refreshIn = (expiresIn - 300) * 1000;
            if (refreshIn > 0) {
                refreshTimer = setTimeout(async () => {
                    const success = await refreshAccessToken();
                    if (!success) {
                        handleExpiredSession();
                    }
                }, refreshIn);
                console.log(`Token refresh scheduled in ${Math.round(refreshIn / 60000)} minutes`);
            }
        }

        // Handle successful authentication
        async function handleAuthSuccess(tokens) {
            accessToken = tokens.access_token;
            tokenExpiresAt = Date.now() + (tokens.expires_in * 1000);

            localStorage.setItem('google_access_token', accessToken);
            localStorage.setItem('google_token_expires_at', tokenExpiresAt);

            if (tokens.refresh_token) {
                refreshToken = tokens.refresh_token;
                localStorage.setItem('google_refresh_token', refreshToken);
            }

            scheduleTokenRefresh(tokens.expires_in);
            lastTokenCheck = Date.now();

            await fetchUserInfo();
            updateSignInStatus();
        }

        // Initialize Google Sign-In
        function initializeGoogleSignIn() {
            // Use authorization code flow to get refresh tokens
            const codeClient = google.accounts.oauth2.initCodeClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                ux_mode: 'popup',
                callback: async (response) => {
                    if (response.error) {
                        console.error('Auth error:', response.error);
                        return;
                    }

                    try {
                        const tokens = await exchangeCodeForTokens(response.code);
                        await handleAuthSuccess(tokens);
                    } catch (error) {
                        console.error('Token exchange failed:', error);
                    }
                },
            });

            // Create sign-in button
            const signInButton = document.createElement('button');
            signInButton.textContent = 'Sign in with Google';
            signInButton.onclick = () => {
                codeClient.requestCode();
            };

            document.getElementById('googleSignIn').appendChild(signInButton);

            // Try to restore previous session using refresh token
            const savedRefreshToken = localStorage.getItem('google_refresh_token');
            const savedUserInfo = localStorage.getItem('google_user_info');

            if (savedRefreshToken && savedUserInfo) {
                refreshToken = savedRefreshToken;
                userInfo = JSON.parse(savedUserInfo);

                // Show UI immediately, then refresh token in background
                accessToken = localStorage.getItem('google_access_token');
                if (accessToken) {
                    updateSignInStatus();
                }

                // Refresh the access token
                refreshAccessToken().then(success => {
                    if (success) {
                        updateSignInStatus();
                    } else {
                        // Refresh token is invalid, clear everything
                        handleExpiredSession();
                    }
                });
            }
        }

        async function fetchUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    userInfo = await response.json();
                    localStorage.setItem('google_user_info', JSON.stringify(userInfo));

                    // Log user to Google Sheets
                    logUserToSheet(userInfo);
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        async function logUserToSheet(user) {
            try {
                await fetch('/.netlify/functions/log-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: user.email,
                        name: user.name,
                        googleId: user.id,
                        picture: user.picture
                    })
                });
            } catch (error) {
                // Silent fail - don't interrupt user experience for logging
                console.error('Error logging user:', error);
            }
        }
        
        function updateSignInStatus() {
            const signedInInfo = document.getElementById('signedInInfo');
            const googleSignIn = document.getElementById('googleSignIn');
            const signOutLink = document.getElementById('signOutLink');
            const uploadSection = document.getElementById('uploadSection');
            const whySignIn = document.getElementById('whySignIn');
            const howItWorks = document.getElementById('howItWorks');

            if (accessToken) {
                let profileHTML = '<div class="user-profile">';

                if (userInfo) {
                    // Show profile picture, name, and email
                    if (userInfo.picture) {
                        profileHTML += `<img src="${userInfo.picture}" alt="Profile" class="user-profile-pic">`;
                    }
                    profileHTML += '<div class="user-info">';
                    if (userInfo.name) {
                        profileHTML += `<div class="user-name">${userInfo.name}</div>`;
                    }
                    if (userInfo.email) {
                        profileHTML += `<div class="user-email">${userInfo.email}</div>`;
                    }
                    profileHTML += '</div>';
                } else {
                    // Fallback if user info not available
                    profileHTML += '<span>Signed in</span>';
                }

                profileHTML += '</div>';

                signedInInfo.innerHTML = profileHTML;
                signedInInfo.style.display = 'flex';
                signOutLink.style.display = 'block';
                googleSignIn.style.display = 'none';
                uploadSection.style.display = 'block';
                whySignIn.style.display = 'none';
                howItWorks.style.display = 'none';
            } else {
                signedInInfo.style.display = 'none';
                signOutLink.style.display = 'none';
                googleSignIn.style.display = 'block';
                uploadSection.style.display = 'none';
                whySignIn.style.display = 'block';
                howItWorks.style.display = 'block';
            }
        }

        function signOut() {
            // Clear all tokens and user info
            accessToken = null;
            refreshToken = null;
            tokenExpiresAt = null;
            userInfo = null;

            // Cancel scheduled refresh
            if (refreshTimer) {
                clearTimeout(refreshTimer);
                refreshTimer = null;
            }

            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_refresh_token');
            localStorage.removeItem('google_token_expires_at');
            localStorage.removeItem('google_user_info');

            // Hide events and buttons
            eventsPreview.style.display = 'none';
            addToCalendarBtn.style.display = 'none';
            extractedEvents = [];

            // Reset upload section
            selectedFile = null;
            processBtn.style.display = 'none';
            updateUploadSection();

            // Update UI (this will hide the upload section)
            updateSignInStatus();
        }
        
        // File Upload Handling
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const processBtn = document.getElementById('processBtn');
        const addToCalendarBtn = document.getElementById('addToCalendarBtn');
        const eventsPreview = document.getElementById('eventsPreview');
        
        function updateUploadSection() {
            if (selectedFile) {
                // Show file selected state
                uploadSection.classList.add('has-file');

                // Check if file is an image (not PDF)
                const isImage = selectedFile.type.startsWith('image/');
                const thumbnailHTML = isImage
                    ? `<img class="upload-thumbnail" src="${URL.createObjectURL(selectedFile)}" alt="Preview">`
                    : `<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>`;

                uploadSection.innerHTML = `
                    <input type="file" id="fileInput" accept=".pdf,image/*">
                    <div class="upload-content">
                        ${thumbnailHTML}
                        <div>
                            <span class="upload-label">File selected</span>
                            <span class="upload-sublabel">${selectedFile.name}</span>
                        </div>
                    </div>
                `;

                const newFileInput = document.getElementById('fileInput');
                newFileInput.addEventListener('change', handleFileSelect);
                newFileInput.addEventListener('click', (e) => e.stopPropagation());
            } else {
                // Show default upload UI
                uploadSection.classList.remove('has-file');
                uploadSection.innerHTML = `
                    <input type="file" id="fileInput" accept=".pdf,image/*">
                    <div class="upload-content">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 15V3M12 3L8 7M12 3L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 17L2 19C2 20.1046 2.89543 21 4 21L20 21C21.1046 21 22 20.1046 22 19V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div>
                            <span class="upload-label">Click to upload an image</span>
                            <span class="upload-sublabel">or drag and drop</span>
                        </div>
                    </div>
                `;

                const newFileInput = document.getElementById('fileInput');
                newFileInput.addEventListener('change', handleFileSelect);
                newFileInput.addEventListener('click', (e) => e.stopPropagation());
            }
        }

        function handleFileSelect(e) {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                processBtn.style.display = 'block';
                updateUploadSection();
            }
        }

        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                processBtn.style.display = 'block';
                updateUploadSection();
            }
        });
        
        uploadSection.addEventListener('click', (e) => {
            // Don't trigger if clicking on the change file link
            if (e.target.id === 'changeFileLink' || e.target.classList.contains('change-file-link')) {
                return;
            }
            e.stopPropagation();
            const currentFileInput = document.getElementById('fileInput');
            if (currentFileInput) {
                currentFileInput.click();
            }
        });

        // Prevent file input change from bubbling
        fileInput.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Process PDF
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) {
                return;
            }

            processBtn.disabled = true;
            processBtn.innerHTML = `
                <div class="button-spinner"></div>
                <span>Processing...</span>
            `;

            try {
                // Compress image if needed, then convert to base64
                const processedFile = await compressImage(selectedFile);
                const fileContent = await fileToBase64(processedFile);
                
                // Call backend function
                // Send local date to server for accurate date parsing
                const now = new Date();
                const localDate = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const localYear = now.getFullYear();

                const response = await fetch('/.netlify/functions/parse-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fileContent: fileContent,
                        fileName: selectedFile.name,
                        clientDate: localDate,
                        clientYear: localYear
                    })
                });
                
                if (!response.ok) {
                    const error = new Error(`Server error: ${response.status}`);
                    error.status = response.status;
                    throw error;
                }
                
                const data = await response.json();

                // Debug: log what AI returned
                console.log('AI raw response:', data.rawResponse);

                if (data.error) {
                    // AI response couldn't be parsed or other error
                    displayNoEventsFound(data.message);
                    addToCalendarBtn.style.display = 'none';
                } else if (data.events && data.events.length > 0) {
                    extractedEvents = data.events;
                    displayEvents(data.events, data.message);
                    addToCalendarBtn.style.display = 'block';
                } else {
                    // No events found - show AI's explanation
                    displayNoEventsFound(data.message);
                    addToCalendarBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);

                let errorMessage;
                if (error.status === 400) {
                    errorMessage = "The file is too large to process. Please try a smaller image or take a screenshot of the document instead.";
                } else if (error.status === 500) {
                    errorMessage = "Something went wrong on our end. Please try again in a moment.";
                } else if (!navigator.onLine) {
                    errorMessage = "You appear to be offline. Please check your internet connection and try again.";
                } else {
                    errorMessage = "Something went wrong while processing your image. Please try again.";
                }

                eventsPreview.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #991b1b; margin-bottom: 12px; font-size: 1.1em;">Oops!</h3>
                        <p style="color: #555; line-height: 1.6; margin-bottom: 0;">${errorMessage}</p>
                    </div>
                `;
                eventsPreview.style.display = 'block';
                addToCalendarBtn.style.display = 'none';
                document.getElementById('reportProblemLink').style.display = 'block';
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = `
                    <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>Process Image</span>
                `;
            }
        });
        
        // Add events to calendar
        addToCalendarBtn.addEventListener('click', async () => {
            if (!accessToken) {
                return;
            }

            if (extractedEvents.length === 0) {
                return;
            }

            addToCalendarBtn.disabled = true;

            try {
                let successCount = 0;
                let failCount = 0;

                // Get user's timezone
                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                for (const event of extractedEvents) {
                    try {
                        // Add timezone to event if using dateTime
                        const calendarEvent = { ...event };

                        // Ensure summary field exists (Google Calendar requires it)
                        if (!calendarEvent.summary && calendarEvent.title) {
                            calendarEvent.summary = calendarEvent.title;
                            delete calendarEvent.title;
                        }

                        if (calendarEvent.start && calendarEvent.start.dateTime) {
                            calendarEvent.start.timeZone = timeZone;
                        }
                        if (calendarEvent.end && calendarEvent.end.dateTime) {
                            calendarEvent.end.timeZone = timeZone;
                        }

                        console.log('Sending event to Google Calendar:', JSON.stringify(calendarEvent, null, 2));

                        const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(calendarEvent)
                        });
                        
                        if (response.ok) {
                            successCount++;
                            console.log('Successfully added event:', calendarEvent.summary);
                        } else {
                            failCount++;
                            const errorText = await response.text();
                            console.error('Failed to add event:', calendarEvent.summary, errorText);
                        }
                    } catch (error) {
                        failCount++;
                        console.error('Error adding event:', error);
                    }
                }

                // Show feedback to user
                if (successCount > 0 || failCount > 0) {
                    const message = `Added ${successCount} event(s) successfully${failCount > 0 ? `, ${failCount} failed` : ''}`;
                    alert(message);
                    console.log(message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding events: ' + error.message);
            } finally {
                addToCalendarBtn.disabled = false;
            }
        });
        
        // Helper Functions
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Compress image to stay under Netlify's 1MB limit
        function compressImage(file, maxSizeKB = 700, maxDimension = 1600) {
            return new Promise((resolve, reject) => {
                // If not an image, return as-is
                if (!file.type.startsWith('image/')) {
                    resolve(file);
                    return;
                }

                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = () => {
                    // Calculate new dimensions
                    let { width, height } = img;
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = (height / width) * maxDimension;
                            width = maxDimension;
                        } else {
                            width = (width / height) * maxDimension;
                            height = maxDimension;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Try different quality levels to get under maxSizeKB
                    let quality = 0.8;
                    const tryCompress = () => {
                        canvas.toBlob(
                            (blob) => {
                                if (blob.size > maxSizeKB * 1024 && quality > 0.3) {
                                    quality -= 0.1;
                                    tryCompress();
                                } else {
                                    // Create a new File from the blob
                                    const compressedFile = new File([blob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    });
                                    console.log(`Compressed: ${(file.size/1024).toFixed(0)}KB â†’ ${(compressedFile.size/1024).toFixed(0)}KB`);
                                    resolve(compressedFile);
                                }
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    tryCompress();
                };

                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }
        
        async function addSingleEventToCalendar(event, button, eventCard) {
            // Belt and suspenders: validate before action
            if (!await ensureValidToken()) {
                return; // User will see reconnect prompt
            }

            button.disabled = true;
            button.innerHTML = `
                <svg class="event-button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                <span class="event-button-text">Adding...</span>
            `;

            try {
                // Get user's timezone
                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                // Add timezone to event if using dateTime
                const calendarEvent = { ...event };

                // Ensure summary field exists (Google Calendar requires it)
                if (!calendarEvent.summary && calendarEvent.title) {
                    calendarEvent.summary = calendarEvent.title;
                    delete calendarEvent.title;
                }

                if (calendarEvent.start && calendarEvent.start.dateTime) {
                    calendarEvent.start.timeZone = timeZone;
                }
                if (calendarEvent.end && calendarEvent.end.dateTime) {
                    calendarEvent.end.timeZone = timeZone;
                }

                const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(calendarEvent)
                });

                if (response.ok) {
                    const createdEvent = await response.json();
                    const editLink = createdEvent.htmlLink;

                    button.classList.add('added');
                    button.innerHTML = `
                        <svg class="event-button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span class="event-button-text">Added</span>
                    `;
                    eventCard.classList.add('added');

                    // Add "Edit" button to open event in Google Calendar
                    if (editLink) {
                        // Wrap buttons in a container for vertical stacking
                        const wrapper = document.createElement('div');
                        wrapper.className = 'event-buttons-wrapper';
                        button.parentNode.insertBefore(wrapper, button);
                        wrapper.appendChild(button);

                        const editButton = document.createElement('a');
                        editButton.href = editLink;
                        editButton.target = '_blank';
                        editButton.rel = 'noopener noreferrer';
                        editButton.className = 'event-button event-edit-button';
                        editButton.innerHTML = `
                            <svg class="event-button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            <span class="event-button-text">Edit</span>
                        `;
                        wrapper.appendChild(editButton);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Failed to add event:', event, errorText);
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="event-button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span class="event-button-text">Add</span>
                    `;
                }
            } catch (error) {
                console.error('Error adding event:', error);
                button.disabled = false;
                button.innerHTML = `
                    <svg class="event-button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span class="event-button-text">Add</span>
                `;
            }
        }

        function displayEvents(events, aiMessage) {
            // Build the AI narrative section
            const narrativeHTML = aiMessage
                ? `<div class="ai-narrative">
                        <span class="ai-icon">âœ¨</span>
                        <span class="ai-message">${aiMessage}</span>
                   </div>`
                : '';

            eventsPreview.innerHTML = `${narrativeHTML}<div class="events-list"></div>`;
            const eventsList = eventsPreview.querySelector('.events-list');

            events.forEach((event, index) => {
                const eventCard = document.createElement('div');
                eventCard.className = 'event-item';

                const startDate = new Date(event.start.dateTime || event.start.date);
                const endDate = event.end ? new Date(event.end.dateTime || event.end.date) : null;

                // Format date and time
                const dateStr = startDate.toLocaleDateString();
                const timeStr = event.start.dateTime ? startDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'All day';

                eventCard.innerHTML = `
                    <div class="event-content">
                        <div class="event-info">
                            <div class="event-title">${event.summary || event.title || 'Untitled Event'}</div>
                            <div class="event-details">
                                <div class="event-detail-row">
                                    <svg class="event-detail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <span>${dateStr}, ${timeStr}</span>
                                </div>
                                ${event.location ? `
                                    <div class="event-detail-row">
                                        <svg class="event-detail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                        <span>${event.location}</span>
                                    </div>
                                ` : ''}
                                ${event.description ? `
                                    <div class="event-detail-row">
                                        <svg class="event-detail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                        <span>${event.description}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <button class="event-button" data-event-index="${index}">
                            <svg class="event-button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span class="event-button-text">Add</span>
                        </button>
                    </div>
                `;

                const addButton = eventCard.querySelector('.event-button');
                console.log('Attaching click handler to button:', addButton, 'for event:', event);
                addButton.onclick = () => {
                    console.log('Button clicked!');
                    addSingleEventToCalendar(event, addButton, eventCard);
                };

                eventsList.appendChild(eventCard);
            });
            eventsPreview.style.display = 'block';
            document.getElementById('reportProblemLink').style.display = 'block';
        }

        function displayNoEventsFound(aiMessage) {
            eventsPreview.innerHTML = `
                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #991b1b; margin-bottom: 12px; font-size: 1.1em;">No events found</h3>
                    <p style="color: #555; line-height: 1.6; margin-bottom: 0;">${aiMessage || "We couldn't extract any calendar events from this image. Try uploading a clearer image of an event flyer, invitation, or schedule."}</p>
                </div>
            `;
            eventsPreview.style.display = 'block';
            document.getElementById('reportProblemLink').style.display = 'block';
        }

        // ============ REPORT PROBLEM MODAL ============

        function openReportModal() {
            const overlay = document.getElementById('reportModalOverlay');
            const fileInput = document.getElementById('reportFileInput');
            const fileInfo = document.getElementById('reportFileInfo');

            // Attach the currently selected file to the hidden input
            if (selectedFile) {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(selectedFile);
                fileInput.files = dataTransfer.files;
                fileInfo.textContent = `File attached: ${selectedFile.name}`;
            } else {
                fileInfo.textContent = '';
            }

            overlay.classList.add('active');
        }

        function closeReportModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('reportModalOverlay').classList.remove('active');
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', () => {
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = reportForm.querySelector('.report-submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Sending...';

                    try {
                        const formData = new FormData(reportForm);
                        const response = await fetch('/', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            closeReportModal();
                            alert('Thank you! Your report has been submitted.');
                            reportForm.reset();
                        } else {
                            alert('Sorry, there was a problem submitting your report. Please try again.');
                        }
                    } catch (error) {
                        console.error('Report submission error:', error);
                        alert('Sorry, there was a problem submitting your report. Please try again.');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Send Report';
                    }
                });
            }
        });

        // Initialize when page loads
        window.onload = () => {
            initializeGoogleSignIn();
        };
    </script>
    <script src="analytics.js"></script>
    <script src="email-capture.js"></script>
</body>
</html>